#!/bin/bash
export vblank_mode=0
if [ -z "$WAYLAND_DISPLAY" ]; then
	echo "Running on X11"
	export MESA_VK_WSI_PRESENT_MODE=immediate
else
	echo "Running on Wayland"
	#export MESA_VK_WSI_PRESENT_MODE=mailbox
	export MESA_VK_WSI_PRESENT_MODE=immediate
fi
#export RADV_DEBUG=nodisplaydcc
#export RADV_PERFTEST=nodcc
#export vk_xwayland_wait_ready=true
#export RADV_DEBUG=zerovram

if [[ "$(basename $0)" == "use-chromium-flags" ]]; then
	echo "Script should be invoked through a symlink"
	exit 1
fi

flags=$(parse-chromium-flags "/etc/chromium-flags.conf")
extraflags=$(parse-chromium-flags "/etc/chromium-flags-$(basename $0).conf")

arguments=$(echo "$flags" | grep -o ' ' | wc -l)
extraarguments=$(echo "$extraflags" | grep -o ' ' | wc -l)

# Only increase if there are any characters in /etc/chromium-flags*.conf
if [ ! -z "$flags" ]; then
	arguments=$((arguments+1))
fi
if [ ! -z "$extraflags" ]; then
	extraarguments=$((extraarguments+1))
fi

echo "/etc/chromium-flags.conf: $arguments flag(s)"
echo "/etc/chromium-flags-$(basename $0).conf: $extraarguments flag(s)"

if [ ! -z "$extraflags" ]; then
	flags="$flags $extraflags"
fi

"/usr/bin/$(basename $0)" $flags "$@"
